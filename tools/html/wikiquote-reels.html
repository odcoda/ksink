<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wikiquote Reels</title>
  <style>
* {
  box-sizing: border-box;
}

:root {
  --ink: #0d0f14;
  --paper: #f6efe2;
  --glow: rgba(247, 206, 127, 0.35);
  --edge: rgba(255, 255, 255, 0.12);
  --shadow: rgba(5, 6, 8, 0.65);
  --accent: #f1b964;
  --accent-soft: rgba(241, 185, 100, 0.3);
}

body {
  margin: 0;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  background: radial-gradient(circle at 20% 20%, #1a1c26 0%, #0b0d12 45%, #06070a 100%);
  color: #f3ede3;
  height: 100vh;
}

.app {
  position: relative;
  height: 100vh;
  max-width: 540px;
  margin: 0 auto;
  overflow: hidden;
}

.feed {
  position: relative;
  height: 100vh;
  overflow-y: auto;
  scroll-snap-type: y mandatory;
  scrollbar-width: none;
}

.feed::-webkit-scrollbar {
  width: 0;
  height: 0;
}

.loading {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  text-align: center;
  padding: 0 24px;
  font-size: 0.72rem;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.6);
  pointer-events: none;
  background: rgba(6, 7, 10, 0.6);
  z-index: 4;
}

.loading.hidden {
  opacity: 0;
  transition: opacity 0.4s ease;
}

.loading .title {
  font-size: 1.1rem;
  letter-spacing: 0.12em;
  color: rgba(255, 255, 255, 0.85);
  margin-bottom: 12px;
}

.reel {
  position: relative;
  height: 100vh;
  scroll-snap-align: start;
  scroll-snap-stop: always;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 96px 20px 130px;
  color: #f8f3ea;
  background: #0b0d12;
}

.reel::before {
  content: "";
  position: absolute;
  inset: 0;
  background: var(--backdrop, radial-gradient(circle at 10% 20%, #1c2430 0%, #0c0f14 50%, #06080c 100%));
  opacity: 0.95;
}

.reel::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(6, 7, 10, 0.2) 0%, rgba(6, 7, 10, 0.5) 70%, rgba(6, 7, 10, 0.8) 100%);
}

.reel .grain {
  position: absolute;
  inset: 0;
  background-image: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.04) 0px, rgba(255, 255, 255, 0.04) 1px, transparent 1px, transparent 2px);
  opacity: 0.25;
  mix-blend-mode: overlay;
}

.quote-stage {
  position: relative;
  z-index: 2;
  width: min(720px, 86vw);
}

.quote-card {
  position: relative;
  height: min(72vh, 560px);
  background: linear-gradient(160deg, var(--paper) 0%, var(--paper-alt, #f7f1e7) 100%);
  color: var(--ink);
  padding: 38px 36px 30px;
  border-radius: 26px;
  border: 1px solid var(--card-border, rgba(255, 255, 255, 0.4));
  box-shadow: 0 28px 60px var(--shadow), 0 0 0 1px rgba(0, 0, 0, 0.12);
  display: flex;
  flex-direction: column;
  gap: 18px;
  overflow: hidden;
}

.quote-card::before {
  content: "";
  position: absolute;
  inset: 14px;
  border-radius: 20px;
  border: 1px solid rgba(0, 0, 0, 0.08);
  pointer-events: none;
}

.quote-mark {
  font-size: 64px;
  line-height: 0.9;
  color: var(--mark, var(--accent));
}

.quote-text {
  flex: 1;
  overflow: hidden;
}

blockquote {
  margin: 0;
  font-size: var(--quote-size, 34px);
  font-weight: var(--quote-weight, 600);
  line-height: var(--quote-line, 1.25);
  letter-spacing: var(--quote-spacing, 0.01em);
  font-style: var(--quote-style, normal);
  font-variant: var(--quote-variant, normal);
  text-align: var(--quote-align, left);
  color: var(--quote-ink, var(--ink));
  text-shadow: var(--quote-shadow, none);
}

.quote-meta {
  margin-top: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.95rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--meta-ink, #3f3a33);
}

.quote-meta .work {
  text-transform: none;
  letter-spacing: 0.02em;
  font-size: 0.9rem;
  color: var(--meta-work, #5a5146);
}

.quote-meta a {
  text-decoration: none;
  color: var(--link-ink, #a45a14);
  font-size: 0.8rem;
  font-weight: 600;
  letter-spacing: 0.12em;
}

.quote-meta a:hover {
  color: var(--link-hover, #7c3d0a);
}

.reel-actions {
  position: absolute;
  right: 18px;
  bottom: 120px;
  z-index: 3;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.action-btn {
  width: 54px;
  height: 54px;
  border-radius: 50%;
  background: rgba(10, 12, 16, 0.65);
  border: 1px solid var(--edge);
  color: #f8f3ea;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 11px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
}

.action-btn svg {
  width: 22px;
  height: 22px;
  fill: none;
  stroke: currentColor;
  stroke-width: 1.5;
}

.action-btn .count {
  font-size: 10px;
  letter-spacing: 0.1em;
}

.reel-info {
  position: absolute;
  left: 18px;
  bottom: 96px;
  z-index: 3;
  max-width: 70%;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.9rem;
}

.reel-info .handle {
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.reel-info .caption {
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.82rem;
}

.progress {
  position: absolute;
  top: 56px;
  left: 16px;
  right: 16px;
  height: 3px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.15);
  overflow: hidden;
  z-index: 3;
}

.progress-bar {
  height: 100%;
  width: 0;
  display: block;
  background: linear-gradient(90deg, var(--accent) 0%, #f7ddb4 100%);
}

.reel.active .progress-bar {
  animation: progress var(--progress-duration, 8500ms) linear forwards;
}

@keyframes progress {
  from {
    width: 0;
  }
  to {
    width: 100%;
  }
}

.top-bar {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 540px;
  height: 56px;
  z-index: 5;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.top-tabs {
  display: flex;
  gap: 16px;
  padding: 6px 16px;
  border-radius: 999px;
  border: 1px solid var(--edge);
  background: rgba(10, 12, 16, 0.6);
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 0.72rem;
}

.tab {
  color: rgba(255, 255, 255, 0.6);
}

.tab.active {
  color: #f7f2e8;
  font-weight: 600;
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 540px;
  height: 72px;
  z-index: 5;
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: linear-gradient(180deg, rgba(6, 7, 10, 0) 0%, rgba(6, 7, 10, 0.9) 70%);
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.5);
}

.nav-item.active {
  color: #f4e7d1;
}

.nav-icon {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  border: 1px solid var(--edge);
  display: grid;
  place-items: center;
  color: inherit;
}

.nav-icon svg {
  width: 16px;
  height: 16px;
  stroke: currentColor;
  fill: none;
  stroke-width: 1.6;
}

.nav-item.active .nav-icon {
  background: #f4e7d1;
  color: #151515;
  border-color: #f4e7d1;
}

.sentinel {
  height: 1px;
}

@media (max-width: 640px) {
  .app {
    max-width: 100%;
  }

  .quote-card {
    height: min(70vh, 520px);
    padding: 32px 28px 26px;
  }

  .quote-mark {
    font-size: 52px;
  }

  .reel-actions {
    right: 12px;
  }

  .reel-info {
    left: 12px;
  }
}

@media (prefers-reduced-motion: reduce) {
  .feed {
    scroll-behavior: auto;
  }

  .reel.active .progress-bar {
    animation: none;
    width: 100%;
  }
}
  </style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div class="top-tabs">
        <span class="tab">Following</span>
        <span class="tab active">For You</span>
      </div>
    </header>

    <main class="feed" id="feed" aria-live="polite">
      <div class="loading" id="loading">
        <div>
          <div class="title">Summoning the canon</div>
          Fetching live quotes from Wikiquote
        </div>
      </div>
    </main>

    <nav class="bottom-nav">
      <div class="nav-item active">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 11l8-7 8 7v8a1 1 0 0 1-1 1h-4v-6H9v6H5a1 1 0 0 1-1-1z"></path>
          </svg>
        </div>
        Home
      </div>
      <div class="nav-item">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="11" cy="11" r="6"></circle>
            <path d="M20 20l-3.5-3.5"></path>
          </svg>
        </div>
        Search
      </div>
      <div class="nav-item">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
        </div>
        Create
      </div>
      <div class="nav-item">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 6h16v10H7l-3 3z"></path>
          </svg>
        </div>
        Inbox
      </div>
      <div class="nav-item">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="8" r="4"></circle>
            <path d="M4 20c2-4 6-6 8-6s6 2 8 6"></path>
          </svg>
        </div>
        Profile
      </div>
    </nav>
  </div>

  <script type="module">
// code in here should not be indented at the first level
const feed = document.getElementById('feed');
const loading = document.getElementById('loading');

const books = [
  { title: 'A Tale of Two Cities', author: 'Charles Dickens', page: 'A_Tale_of_Two_Cities' },
  { title: 'Moby-Dick', author: 'Herman Melville', page: 'Moby-Dick' },
  { title: 'Anna Karenina', author: 'Leo Tolstoy', page: 'Anna_Karenina' },
  { title: 'Pride and Prejudice', author: 'Jane Austen', page: 'Pride_and_Prejudice' },
  { title: 'Jane Eyre', author: 'Charlotte Bronte', page: 'Jane_Eyre' },
  { title: 'Wuthering Heights', author: 'Emily Bronte', page: 'Wuthering_Heights' },
  { title: 'Frankenstein', author: 'Mary Shelley', page: 'Frankenstein' },
  { title: 'The Picture of Dorian Gray', author: 'Oscar Wilde', page: 'The_Picture_of_Dorian_Gray' },
  { title: 'Hamlet', author: 'William Shakespeare', page: 'Hamlet' },
  { title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', page: 'The_Great_Gatsby' },
  { title: 'Fahrenheit 451', author: 'Ray Bradbury', page: 'Fahrenheit_451' },
  { title: 'Adventures of Huckleberry Finn', author: 'Mark Twain', page: 'Adventures_of_Huckleberry_Finn' },
  { title: 'Crime and Punishment', author: 'Fyodor Dostoevsky', page: 'Crime_and_Punishment' },
  { title: 'The Brothers Karamazov', author: 'Fyodor Dostoevsky', page: 'The_Brothers_Karamazov' },
  { title: 'The Odyssey', author: 'Homer', page: 'The_Odyssey' },
  { title: 'The Count of Monte Cristo', author: 'Alexandre Dumas', page: 'The_Count_of_Monte_Cristo' },
  { title: 'Les Miserables', author: 'Victor Hugo', page: 'Les_Miserables' },
  { title: 'Great Expectations', author: 'Charles Dickens', page: 'Great_Expectations' },
  { title: 'The Grapes of Wrath', author: 'John Steinbeck', page: 'The_Grapes_of_Wrath' },
  { title: 'Dracula', author: 'Bram Stoker', page: 'Dracula' }
];

const themes = [
  {
    accent: '#f1b964',
    accentSoft: 'rgba(241, 185, 100, 0.3)',
    paper: '#f7f1e7',
    paperAlt: '#efe2d0',
    ink: '#2c2116',
    mark: '#d08a3b',
    metaInk: '#4c3b2b',
    metaWork: '#6a5946',
    link: '#a45a14',
    linkHover: '#7c3d0a',
    border: 'rgba(255, 255, 255, 0.5)',
    shadow: 'rgba(8, 6, 5, 0.55)',
    backdrop: 'radial-gradient(circle at 15% 20%, #263041 0%, #131722 55%, #0a0c12 100%)'
  },
  {
    accent: '#d08a5b',
    accentSoft: 'rgba(208, 138, 91, 0.3)',
    paper: '#f3e7d6',
    paperAlt: '#e9d7c1',
    ink: '#2f2018',
    mark: '#b8683d',
    metaInk: '#4b3529',
    metaWork: '#6a5246',
    link: '#9a4d22',
    linkHover: '#6e3714',
    border: 'rgba(255, 255, 255, 0.42)',
    shadow: 'rgba(8, 4, 2, 0.6)',
    backdrop: 'radial-gradient(circle at 70% 20%, #2e2a24 0%, #151310 55%, #090807 100%)'
  },
  {
    accent: '#8fbad6',
    accentSoft: 'rgba(143, 186, 214, 0.3)',
    paper: '#eef3f5',
    paperAlt: '#e4edf2',
    ink: '#1f2b36',
    mark: '#4f86a4',
    metaInk: '#30404d',
    metaWork: '#4c5a66',
    link: '#2c5f7b',
    linkHover: '#1f4356',
    border: 'rgba(255, 255, 255, 0.45)',
    shadow: 'rgba(5, 7, 10, 0.55)',
    backdrop: 'radial-gradient(circle at 20% 70%, #1b2a35 0%, #0e141b 55%, #07090c 100%)'
  },
  {
    accent: '#c7a073',
    accentSoft: 'rgba(199, 160, 115, 0.35)',
    paper: '#f2ead9',
    paperAlt: '#e8dcc4',
    ink: '#2b2318',
    mark: '#a07a50',
    metaInk: '#4d3d2d',
    metaWork: '#6a5845',
    link: '#8a5d34',
    linkHover: '#64421f',
    border: 'rgba(255, 255, 255, 0.35)',
    shadow: 'rgba(7, 6, 4, 0.6)',
    backdrop: 'radial-gradient(circle at 80% 30%, #2a2b2e 0%, #151619 55%, #0b0c0f 100%)'
  },
  {
    accent: '#b8b6b2',
    accentSoft: 'rgba(184, 182, 178, 0.35)',
    paper: '#f4f2ee',
    paperAlt: '#e7e3dc',
    ink: '#272427',
    mark: '#848079',
    metaInk: '#3f3c40',
    metaWork: '#5f5a5e',
    link: '#6a5b54',
    linkHover: '#4f3f38',
    border: 'rgba(255, 255, 255, 0.32)',
    shadow: 'rgba(6, 6, 7, 0.55)',
    backdrop: 'radial-gradient(circle at 20% 30%, #2f2c31 0%, #17161b 55%, #0b0b10 100%)'
  },
  {
    accent: '#a3b49c',
    accentSoft: 'rgba(163, 180, 156, 0.32)',
    paper: '#eef1e7',
    paperAlt: '#e1e7d6',
    ink: '#273125',
    mark: '#6c8a63',
    metaInk: '#40503c',
    metaWork: '#5c6c56',
    link: '#4e6d44',
    linkHover: '#3a5232',
    border: 'rgba(255, 255, 255, 0.38)',
    shadow: 'rgba(4, 6, 4, 0.55)',
    backdrop: 'radial-gradient(circle at 30% 25%, #2a3026 0%, #151812 55%, #0b0d09 100%)'
  }
];

const textVariants = [
  {
    size: 40,
    weight: 600,
    spacing: '0.01em',
    line: 1.22,
    style: 'normal',
    variant: 'normal',
    align: 'left',
    shadow: 'none'
  },
  {
    size: 36,
    weight: 500,
    spacing: '0.02em',
    line: 1.3,
    style: 'italic',
    variant: 'normal',
    align: 'left',
    shadow: '0 14px 26px rgba(0, 0, 0, 0.08)'
  },
  {
    size: 34,
    weight: 700,
    spacing: '0.04em',
    line: 1.18,
    style: 'normal',
    variant: 'small-caps',
    align: 'left',
    shadow: 'none'
  },
  {
    size: 38,
    weight: 550,
    spacing: '0.015em',
    line: 1.28,
    style: 'normal',
    variant: 'normal',
    align: 'left',
    shadow: '0 18px 30px rgba(0, 0, 0, 0.12)'
  },
  {
    size: 35,
    weight: 600,
    spacing: '0.03em',
    line: 1.24,
    style: 'normal',
    variant: 'normal',
    align: 'center',
    shadow: 'none'
  }
];

const MAX_WORDS = 500;
const MIN_WORDS = 4;
const MIN_FONT_SIZE = 16;
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

let autoAdvanceTimer = null;
let bookQueue = [];
let isAdding = false;
const bookQuotes = new Map();

function shuffle(list) {
  const array = [...list];
  for (let i = array.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function wordCount(text) {
  return text.split(/\s+/).filter(Boolean).length;
}

function normalizeText(text) {
  return text
    .replace(/[“”]/g, '"')
    .replace(/[‘’]/g, "'")
    .replace(/[—–]/g, '-')
    .replace(/\s+/g, ' ')
    .trim();
}

function stripTemplates(text) {
  let cleaned = text;
  let previous;
  do {
    previous = cleaned;
    cleaned = cleaned.replace(/\{\{[^{}]*\}\}/g, ' ');
  } while (cleaned !== previous);
  return cleaned;
}

function cleanLine(line) {
  let text = line.replace(/^\*+/, '').trim();
  if (!text || text.startsWith(':') || text.startsWith('#')) {
    return '';
  }

  text = stripTemplates(text);
  text = text
    .replace(/<ref[^>]*>.*?<\/ref>/gi, ' ')
    .replace(/<ref[^/>]*\/>/gi, ' ')
    .replace(/<!--.*?-->/g, ' ')
    .replace(/<\/?.*?poem[^>]*>/gi, ' ')
    .replace(/<\/?.*?blockquote[^>]*>/gi, ' ')
    .replace(/<br\s*\/?>/gi, ' ')
    .replace(/\[\[(?:[^|\]]*\|)?([^\]]+)\]\]/g, '$1')
    .replace(/\[https?:\/\/[^\s\]]+\s([^\]]+)\]/g, '$1')
    .replace(/\[https?:\/\/[^\]]+\]/g, ' ')
    .replace(/''+/g, '')
    .replace(/&nbsp;/g, ' ')
    .replace(/&mdash;|&ndash;/g, '-')
    .replace(/&amp;/g, '&');

  text = normalizeText(text);

  if (text.includes('ISBN') || text.includes('citation needed')) {
    return '';
  }

  return text;
}

function extractQuotes(wikitext) {
  const results = [];
  const seen = new Set();
  const lines = wikitext.split('\n');

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed.startsWith('*')) {
      continue;
    }

    const text = cleanLine(trimmed);
    if (!text || seen.has(text)) {
      continue;
    }

    const count = wordCount(text);
    if (count < MIN_WORDS || count > MAX_WORDS) {
      continue;
    }

    if (text.length < 12) {
      continue;
    }

    seen.add(text);
    results.push(text);
  }

  return results;
}

function formatCount() {
  const value = Math.floor(Math.random() * 9500) + 120;
  if (value >= 1000) {
    const rounded = Math.round(value / 100) / 10;
    return `${rounded}k`;
  }
  return String(value);
}

function getDuration() {
  return 7200 + Math.floor(Math.random() * 2500);
}

function createActionButton(label, count, icon) {
  const button = document.createElement('button');
  button.type = 'button';
  button.className = 'action-btn';
  button.setAttribute('aria-label', label);
  button.innerHTML = `${icon}<span class="count">${count}</span>`;
  return button;
}

function setReelTheme(reel) {
  const theme = themes[Math.floor(Math.random() * themes.length)];
  const variant = textVariants[Math.floor(Math.random() * textVariants.length)];
  const inkShift = Math.random() > 0.5 ? theme.ink : '#1f1f1f';

  reel.style.setProperty('--accent', theme.accent);
  reel.style.setProperty('--accent-soft', theme.accentSoft);
  reel.style.setProperty('--paper', theme.paper);
  reel.style.setProperty('--paper-alt', theme.paperAlt);
  reel.style.setProperty('--ink', theme.ink);
  reel.style.setProperty('--mark', theme.mark);
  reel.style.setProperty('--meta-ink', theme.metaInk);
  reel.style.setProperty('--meta-work', theme.metaWork);
  reel.style.setProperty('--link-ink', theme.link);
  reel.style.setProperty('--link-hover', theme.linkHover);
  reel.style.setProperty('--card-border', theme.border);
  reel.style.setProperty('--shadow', theme.shadow);
  reel.style.setProperty('--backdrop', theme.backdrop);

  reel.style.setProperty('--quote-size', `${variant.size}px`);
  reel.style.setProperty('--quote-weight', variant.weight);
  reel.style.setProperty('--quote-spacing', variant.spacing);
  reel.style.setProperty('--quote-line', variant.line);
  reel.style.setProperty('--quote-style', variant.style);
  reel.style.setProperty('--quote-variant', variant.variant);
  reel.style.setProperty('--quote-align', variant.align);
  reel.style.setProperty('--quote-shadow', variant.shadow);
  reel.style.setProperty('--quote-ink', inkShift);

  reel.dataset.baseSize = String(variant.size);
}

async function fetchWikiquote(book) {
  const url = new URL('https://en.wikiquote.org/w/api.php');
  url.search = new URLSearchParams({
    action: 'parse',
    page: book.page,
    prop: 'wikitext',
    format: 'json',
    origin: '*'
  }).toString();

  const response = await fetch(url);
  if (!response.ok) {
    return '';
  }

  const data = await response.json();
  return data?.parse?.wikitext?.['*'] || '';
}

function refillBookQueue() {
  bookQueue = shuffle(books);
}

function nextBook() {
  if (bookQueue.length === 0) {
    refillBookQueue();
  }
  return bookQueue.shift();
}

async function getBookQuotes(book) {
  if (bookQuotes.has(book.page)) {
    return bookQuotes.get(book.page);
  }

  try {
    const wikitext = await fetchWikiquote(book);
    if (!wikitext) {
      bookQuotes.set(book.page, []);
      return [];
    }

    const quotes = extractQuotes(wikitext);
    const sourceUrl = `https://en.wikiquote.org/wiki/${encodeURIComponent(book.page)}`;
    const prepared = quotes.map((text) => ({
      text,
      author: book.author,
      work: book.title,
      sourceUrl
    }));

    bookQuotes.set(book.page, prepared);
    return prepared;
  } catch (error) {
    bookQuotes.set(book.page, []);
    return [];
  }
}

async function getNextBookWithQuotes() {
  const maxAttempts = books.length * 2;
  for (let attempt = 0; attempt < maxAttempts; attempt += 1) {
    const book = nextBook();
    if (!book) {
      return null;
    }
    const quotes = await getBookQuotes(book);
    if (quotes.length > 0) {
      return { book, quotes };
    }
  }
  return null;
}

function applyQuote(reel, quote) {
  if (!quote) {
    return;
  }

  reel.querySelector('blockquote').textContent = quote.text;
  reel.querySelector('.author').textContent = quote.author;
  reel.querySelector('.work').textContent = quote.work;
  reel.querySelector('.source-link').href = quote.sourceUrl;

  const captions = reel.querySelectorAll('.caption');
  if (captions[0]) {
    captions[0].textContent = `${quote.work} - ${quote.author}`;
  }
}

function fitQuote(reel) {
  const quoteText = reel.querySelector('.quote-text');
  const blockquote = reel.querySelector('blockquote');
  const baseSize = Number(reel.dataset.baseSize || 34);

  let size = baseSize;
  blockquote.style.fontSize = `${size}px`;

  while (blockquote.scrollHeight > quoteText.clientHeight && size > MIN_FONT_SIZE) {
    size -= 1;
    blockquote.style.fontSize = `${size}px`;
  }

  return blockquote.scrollHeight <= quoteText.clientHeight;
}

function pickDifferentIndex(quotes, currentIndex) {
  if (quotes.length <= 1) {
    return currentIndex;
  }

  let nextIndex = currentIndex;
  while (nextIndex === currentIndex) {
    nextIndex = Math.floor(Math.random() * quotes.length);
  }
  return nextIndex;
}

function setQuoteForReel(reel, quotes, preferredIndex) {
  if (!quotes || quotes.length === 0) {
    return false;
  }

  const tried = new Set();
  let index = typeof preferredIndex === 'number'
    ? preferredIndex
    : Math.floor(Math.random() * quotes.length);
  const maxAttempts = Math.min(quotes.length, 10);

  for (let attempt = 0; attempt < maxAttempts; attempt += 1) {
    if (tried.has(index)) {
      index = Math.floor(Math.random() * quotes.length);
      continue;
    }

    tried.add(index);
    applyQuote(reel, quotes[index]);

    if (fitQuote(reel)) {
      reel.dataset.quoteIndex = String(index);
      return true;
    }

    index = Math.floor(Math.random() * quotes.length);
  }

  let shortestIndex = 0;
  let shortestLength = Infinity;
  quotes.forEach((quote, quoteIndex) => {
    if (quote.text.length < shortestLength) {
      shortestLength = quote.text.length;
      shortestIndex = quoteIndex;
    }
  });

  applyQuote(reel, quotes[shortestIndex]);
  if (fitQuote(reel)) {
    reel.dataset.quoteIndex = String(shortestIndex);
    return true;
  }

  return false;
}

function buildReelShell() {
  const reel = document.createElement('article');
  reel.className = 'reel';
  reel.dataset.duration = String(getDuration());
  setReelTheme(reel);

  reel.innerHTML = `
    <div class="grain"></div>
    <div class="quote-stage">
      <div class="quote-card">
        <div class="quote-mark">"</div>
        <div class="quote-text">
          <blockquote></blockquote>
        </div>
        <div class="quote-meta">
          <span class="author"></span>
          <span class="work"></span>
          <a class="source-link" href="" target="_blank" rel="noopener">Wikiquote</a>
        </div>
      </div>
    </div>
    <div class="reel-info">
      <div class="handle">@shelftok</div>
      <div class="caption"></div>
      <div class="caption">#classiclit #wikiquote</div>
    </div>
    <div class="reel-actions"></div>
    <div class="progress"><span class="progress-bar"></span></div>
  `;

  const actions = reel.querySelector('.reel-actions');
  actions.append(
    createActionButton('Like', formatCount(), `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 20s-7-4.5-7-10a4.5 4.5 0 0 1 8-2.5A4.5 4.5 0 0 1 19 10c0 5.5-7 10-7 10z"></path>
      </svg>
    `),
    createActionButton('Comment', formatCount(), `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 5h16v10H7l-3 3z"></path>
      </svg>
    `),
    createActionButton('Share', formatCount(), `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M16 5l4 4-4 4"></path>
        <path d="M20 9H9"></path>
        <path d="M9 5l-5 4 5 4"></path>
      </svg>
    `),
    createActionButton('Save', formatCount(), `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6 4h12v16l-6-4-6 4z"></path>
      </svg>
    `)
  );

  return reel;
}

async function createReel() {
  const maxAttempts = books.length * 2;

  for (let attempt = 0; attempt < maxAttempts; attempt += 1) {
    const candidate = await getNextBookWithQuotes();
    if (!candidate) {
      return null;
    }

    const { book, quotes } = candidate;
    const reel = buildReelShell();
    reel.dataset.bookPage = book.page;

    const filled = setQuoteForReel(reel, quotes);
    if (!filled) {
      continue;
    }

    reel.addEventListener('click', (event) => {
      if (event.target.closest('a,button')) {
        return;
      }

      const page = reel.dataset.bookPage;
      const storedQuotes = bookQuotes.get(page) || [];
      if (storedQuotes.length === 0) {
        return;
      }

      const currentIndex = Number(reel.dataset.quoteIndex || 0);
      const nextIndex = pickDifferentIndex(storedQuotes, currentIndex);
      setQuoteForReel(reel, storedQuotes, nextIndex);
    });

    return reel;
  }

  return null;
}

async function addReels(count) {
  if (isAdding) {
    return;
  }

  isAdding = true;
  let added = 0;

  for (let i = 0; i < count; i += 1) {
    const reel = await createReel();
    if (!reel) {
      break;
    }
    feed.insertBefore(reel, sentinel);
    reelObserver.observe(reel);
    added += 1;
  }

  if (added === 0 && loading) {
    loading.classList.remove('hidden');
    loading.innerHTML = '<div><div class="title">No quotes found</div>Wikiquote did not respond</div>';
  }

  isAdding = false;
}

function getNextReel(current) {
  let next = current.nextElementSibling;
  while (next && !next.classList.contains('reel')) {
    next = next.nextElementSibling;
  }
  return next;
}

function setActive(reel) {
  if (!reel || reel.classList.contains('active')) {
    return;
  }

  const previous = feed.querySelector('.reel.active');
  if (previous) {
    previous.classList.remove('active');
  }

  reel.classList.add('active');

  if (autoAdvanceTimer) {
    window.clearTimeout(autoAdvanceTimer);
  }

  const duration = Number(reel.dataset.duration || 8500);
  reel.style.setProperty('--progress-duration', `${duration}ms`);

  if (!prefersReducedMotion) {
    autoAdvanceTimer = window.setTimeout(() => {
      const next = getNextReel(reel);
      if (next) {
        next.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, duration);
  }
}

const reelObserver = new IntersectionObserver((entries) => {
  entries.forEach((entry) => {
    if (entry.isIntersecting && entry.intersectionRatio > 0.6) {
      setActive(entry.target);
    }
  });
}, { root: feed, threshold: [0.6, 0.9] });

const sentinel = document.createElement('div');
const sentinelObserver = new IntersectionObserver((entries) => {
  entries.forEach((entry) => {
    if (entry.isIntersecting) {
      addReels(4);
    }
  });
}, { root: feed, rootMargin: '500px' });

async function init() {
  refillBookQueue();
  sentinel.className = 'sentinel';
  feed.appendChild(sentinel);
  await addReels(6);

  const firstReel = feed.querySelector('.reel');
  if (firstReel) {
    setActive(firstReel);
  }

  if (loading) {
    loading.classList.add('hidden');
  }

  sentinelObserver.observe(sentinel);
}

init();
  </script>
</body>
</html>
